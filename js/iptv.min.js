/*! epg-focus v2.3.2 | (c) epg focus system | by XUZHEN https://gitee.com/ywwxly/epg-focus /license */
function iptvFocus(t){t=t||{},this.viewEle=t.viewEle||this.viewEle,this._group=t._group||this._group,this.focusClassScale=t.focusClassScale||this.focusClassScale,this._nowEle=t.nowEle||this._nowEle,this.visualMargin=t.visualMargin||this.visualMargin,this._hasLayer=t.hasLayer||this._hasLayer;var i=location.pathname,e=i.split("/")[i.split("/").length-1];i=e.slice(0,e.indexOf(".")),this.pathname=i,this.animateHas=t.animateHas,this.initNoFocus=t.initNoFocus,this.init()}function functionName(t){var i=t.toString();return i=i.substr("function ".length),i=i.substr(0,i.indexOf("(")),i}function stringToJavascript(string){try{return eval("("+string+")")}catch(t){return!1}}function getTop(t){var i=t.offsetTop;return null!=t.offsetParent&&(i+=getTop(t.offsetParent)),i}function getLeft(t){var i=t.offsetLeft;return null!=t.offsetParent&&(i+=getLeft(t.offsetParent)),i}window.runTime=null,iptvFocus.prototype={version:"^2.3.2",keyEvent:!0,focusClassScale:1.1,visualMargin:30,viewEle:evm.$("view")||document.body,_nowEle:null,_group:"column",_hasLayer:!1,_groupList:null,_foucsList:null,pathname:null,oldEleObj:null,defaultFocus:null,animateHas:!1,initNoFocus:!1,getAttributeEle:function(t,i,e,n){rootEle=(i||document).getElementsByTagName(n||"*");for(var s=[],o=Object.values(rootEle),u=0,r=0;r<o.length;r++){var f=o[r];if(1==f.nodeType&&f.hasAttribute(t)){var l=f.getAttribute(t),a={index:r,focusIndex:u,ele:f,focus:l,groupName:e};if(l){var h=stringToJavascript(l);"function"==typeof h&&(a.focus=h)}f.hasAttribute("default-focus")&&(this._nowEle||(this._nowEle=a),this.defaultFocus=a),this.getEventAttribute(f,a,["blur","left","right","up","down","click","back"]),s.push(a),u++}}return s},getAttributeObj:function(t,i){function e(t,i,e){if(t[e]){var n=stringToJavascript(t[e]);i[e]=n||t[e]}}for(var n=document.getElementsByTagName(i||"*"),s={},o=Object.values(n),u=0;u<o.length;u++){var r=o[u];if(1==r.nodeType&&r.hasAttribute(t)){var f={},l={},a=r.getAttribute(t)||u;"string"==typeof a&&a.indexOf("}")>-1&&(f=stringToJavascript(a),a=f.name||u,e(f,l,"focus"),e(f,l,"blur")),l[t+"Name"]=a,l[t+"Ele"]=r,l.foucsList=this.getAttributeEle("isfocus",r,a),this.defaultFocus&&(l.defaultFocus=this.defaultFocus,this.defaultFocus=null),this.getEventAttribute(r,l,["left","right","up","down","click","back"]),s[a]=l}}return s},getEventAttribute:function(t,i,e){if("string"==typeof e){if(1==t.nodeType&&t.hasAttribute("@"+e)){var n=t.getAttribute("@"+e);if(n){var s=stringToJavascript(n);i[e]="function"==typeof s?s:n}}}else for(var o=0;o<e.length;o++)this.getEventAttribute(t,i,e[o])},getAllFocusList:function(t){function i(t,i){for(var e=0;e<i.length;e++)if(t.ele===i[e].ele)return!1;return!0}var e=[];t=Object.values(t||this._groupList);for(var n=0;n<t.length;n++)t[n].foucsList&&(e=e.concat(t[n].foucsList));if(!this._hasLayer){var s=this.getAttributeEle("isfocus",null,"no");if(t.length!=s.length){for(var o=[],u=0;u<s.length;u++)i(s[u],e)&&o.push(s[u]);e=e.concat(o),o.length>0&&(this._groupList.no={groupName:"no",groupEle:null,foucsList:o})}}return e},findFocusEle:function(t,i,e){var n=null,s=null;i=i||this._foucsList,"string"==typeof t?s=document.getElementById(t):"object"==typeof t&&(s=t);for(var o=0;o<i.length;o++){var u=i[o];if(s){if(s==u.ele){n=u;break}}else if("focusIndex"==e){if(t==u.focusIndex){n=u;break}}else if(t==u.index){n=u;break}}return n},focusGroup:function(t,i){this._groupList[t]&&this._groupList[t].foucsList.length>0&&(i?this.onFocus(this.findFocusEle(i,this._groupList[t].foucsList)):this.onFocus(this._groupList[t].defaultFocus||this._groupList[t].foucsList[0]))},init:function(){this._groupList=this.getAttributeObj("group"),this._foucsList=this.getAllFocusList();var t=evm.cookie(this.pathname);t&&(t=t.split("-"),this._nowEle=this.findFocusEle(t[1],this._groupList[t[0]].foucsList)),this._nowEle=this._nowEle||this._groupList[this._group].foucsList[0],this.initNoFocus||this.onFocus(this._nowEle),runTime=(new Date).getTime()-runTime},onFocus:function(t,i){this.onBlur(i),this._nowEle=t;var e=t.focus;if(this._group=t.groupName,e)"function"==typeof e?this.callFn(e,t,this._group):evm.addClass(t.ele,e);else{var n=this._groupList[this._group].focus;n?"string"==typeof n?evm.addClass(t.ele,n):this.callFn(n,t,this._group):evm.addClass(t.ele,"focus_btn")}},onBlur:function(t){t=t||this._nowEle;var i=t.groupName,e="function"!=typeof t.focus?t.focus:t.blur;if(t){if(e)"function"==typeof e?this.callFn(e,t,i):evm.removeClass(t.ele,e);else{var n=this._groupList[i].blur;if(n)"string"==typeof n?evm.removeClass(t.ele,n):this.callFn(n,t,i);else{var s="";this._groupList[i]&&this._groupList[i].focus&&(s=this._groupList[i].focus),evm.removeClass(t.ele,("string"==typeof t.focus?t.focus:"")||s||"focus_btn")}}this.oldEleObj=t}},saveFocusIndex:function(t){t=t||this._nowEle,t&&evm.cookie(this.pathname,t.groupName+"-"+t.index)},_dirKey:function(t){var i=this._nowEle[t];i?"function"==typeof i?this.callFn(i,this._nowEle,this._nowEle.groupName):this.onFocus(this.findFocusEle(i)):this.move(t)},_doKey:function(t){this._nowEle[t]?this.callFn(this._nowEle[t],this._nowEle,this._nowEle.groupName):this._groupList[this._nowEle.groupName][t]?this.callFn(this._groupList[this._nowEle.groupName][t],this._nowEle,this._nowEle.groupName):"back"==t&&"function"==typeof BackParent&&BackParent()},_down:function(){this._dirKey("down")},_up:function(){this._dirKey("up")},_right:function(){this._dirKey("right")},_left:function(){this._dirKey("left")},_back:function(){evm.cutCookie(this.pathname),this._doKey("back")},_enter:function(){this.saveFocusIndex(),this._doKey("click")},callFn:function(t,i,e){var n=functionName(t);if(n)t(i,this.oldEleObj);else{var s=stringToJavascript(e);t.call(s,i,this.oldEleObj)}},move:function(t,i,e){var n=this.findMin(t,i);if(n.hasMin){var s=this._nowEle;return"left"===t||"right"===t?this._nowEle=n.min:"up"!==t&&"down"!==t||(this._nowEle=n.pref||n.min),this.moveScroll(t,s),this.onFocus(this._nowEle,s),this._nowEle}if(this._groupList[this._group][t]){var o=this._groupList[this._group][t];"function"==typeof o?this.callFn(this._groupList[this._nowEle.groupName][t],this._nowEle,this._nowEle.groupName):this.concatGroupFocus(o,t)}else"noGroup"==e||this._hasLayer||this.move(t,this._foucsList,"noGroup")},findMin:function(t,i){var e,n,s,o;i=i||this._groupList[this._group].foucsList;for(var u=0;u<i.length;u++){item=i[u];var r=this.rules(this._nowEle,item,e,n,t);e=r.pDvalue,n=r.mDvalue,r.pref&&(s=item),r.min&&(o=item)}return{hasMin:(s||o)&&s!=this._nowEle&&o!=this._nowEle,pref:s,min:o}},concatGroupFocus:function(t,i){console.log(t,i,"concatGroupFocus"),console.log(this._groupList[t].foucsList),this._groupList[t]&&this._groupList[t].foucsList.length>0&&this.move(i,this._groupList[this._group].foucsList.concat(this._groupList[t].foucsList))},moveScroll:function(t,i){function e(t,i,e){function s(i){e?t.style.top=i+"px":t.style.left=i+"px"}var o=(new Date).getTime(),u="10_10";if(n.animateHas){var r=parseInt(u.split("_")[0]),f=parseInt(u.split("_")[1]);clearInterval(t.timeId),t.timeId=setInterval(function(){var n=(new Date).getTime()-o;if(console.log(n),n>=500)clearInterval(t.timeId),s(i);else{var u=e?t.offsetTop:t.offsetLeft,f=(i-u)/r;f=f>0?Math.ceil(f):Math.floor(f),u+=f,s(u),Math.abs(u-i)<10&&(s(i),clearInterval(t.timeId))}},f)}else s(i)}var n=this,s=this._groupList[this._nowEle.groupName].groupEle;s||(s=this._nowEle.ele.parentElement),s||(s=this.viewEle);var o,u,r=this.getBoundingClientRect(s),f=this.getBoundingClientRect(this._nowEle.ele),l=i?this.getBoundingClientRect(i.ele):{x:f.width-this.visualMargin,y:f.height-this.visualMargin},a=this.getBoundingClientRect(s.parentElement||this.viewEle),h="up"===t?f.y-a.y:f.y-a.y+f.height,c="left"===t?f.x-a.x:f.x-a.x+f.width,p=a.height||720,g=a.width||1280;if(h>=p)if("left"===t||"right"===t)i&&(this._nowEle=i);else{var _=this.findMin(t,this._groupList[this._nowEle.groupName].focusList);u=_.hasMin?(r.y>this.visualMargin?r.y:r.y-this.visualMargin)-a.y+(p-this.visualMargin)-h:r.y-a.y+(p-this.visualMargin)-h,e(s,u,"top")}else if(h<0){var v=r.y-a.y+l.y-f.y;if(v>0&&v<f.height&&(v=0),Math.abs(v)<this.visualMargin&&(v=0),v){_=this.findMin(t,this._groupList[this._nowEle.groupName].focusList);_.hasMin||(v=0)}e(s,v,"top"),u=v}if(c>g)"left"===t||"right"===t?(o=(r.x>this.visualMargin?r.x:r.x-this.visualMargin)-a.x+(g-this.visualMargin)-c,e(s,o)):i&&(this._nowEle=i);else if(c<0){var d=r.x-a.x+l.x-f.x;if(d>0&&d<f.width&&(d=0),Math.abs(d)<this.visualMargin&&(d=0),d){_=this.findMin(t,this._groupList[this._nowEle.groupName].focusList);_.hasMin||(d=0)}e(s,d),o=d}"function"==typeof moveScroll&&moveScroll({keyDir:t,X:o,Y:u})},getBoundingClientRect:function(t){var i=getLeft(t),e=getTop(t),n=t.offsetWidth,s=t.offsetHeight;return{top:e,bottom:e+s,left:i,right:i+n,width:t.offsetWidth,height:t.offsetHeight,x:i,y:e}},infos:function(t){var i=this.getBoundingClientRect(t);return{width:i.width,height:i.height,left:i.left,right:i.left+i.width,up:i.top,down:i.top+i.height,x:i.x,y:i.y}},distance:function(t,i,e,n){return parseInt(Math.sqrt(Math.pow(t-e,2)+Math.pow(i-n,2)))},contains:function(t,i,e,n){return i-t+(n-e)>=Math.max(t,i,e,n)-Math.min(t,i,e,n)},rules:function(t,i,e,n,s){var o,u,r;if(pinfo=this.infos(t.ele),ninfo=this.infos(i.ele),ninfo.width||ninfo.height)if("up"===s){var f=pinfo.up+pinfo.height*(this.focusClassScale-1)/2+5;f>=ninfo.down&&(o=this.distance(ninfo.left,ninfo.up,pinfo.left,pinfo.up),(!n||o<n)&&(n=o,r=!0),(!e||this.contains(ninfo.left,ninfo.right,pinfo.left,pinfo.right)&&o<e)&&(e=o,u=!0))}else if("down"===s){var l=pinfo.down*(2-this.focusClassScale)-5;l<=ninfo.up&&(o=this.distance(ninfo.left,ninfo.up,pinfo.left,pinfo.up),(!n||o<n)&&(n=o,r=!0),(!e||this.contains(ninfo.left,ninfo.right,pinfo.left,pinfo.right)&&o<e)&&(e=o,u=!0))}else if("left"===s){var a=pinfo.left+pinfo.width*(this.focusClassScale-1)/2+5;a>=ninfo.right&&(o=this.distance(ninfo.right,ninfo.up,pinfo.left,pinfo.up),(!n||o<n)&&(n=o,r=!0),(!e||this.contains(ninfo.up,ninfo.down,pinfo.up,pinfo.down)&&o<e)&&(e=o,u=!0))}else if("right"===s){var h=pinfo.right*(2-this.focusClassScale)-5;h<=ninfo.left&&(o=this.distance(ninfo.left,ninfo.up,pinfo.left,pinfo.up),(!n||o<n)&&(n=o,r=!0),(!e||this.contains(ninfo.up,ninfo.down,pinfo.up,pinfo.down)&&o<e)&&(e=o,u=!0))}return{pDvalue:e,mDvalue:n,pref:u,min:r}}},window.keyevent=function(){var t=iptv;if(t)switch(t.keyEvent||(_keyName="NOTEVENT"),_keyName){case"KEY_LEFT":"function"==typeof t._left&&t._left();break;case"KEY_RIGHT":"function"==typeof t._right&&t._right();break;case"KEY_DOWN":"function"==typeof t._down&&t._down();break;case"KEY_UP":"function"==typeof t._up&&t._up();break;case"KEY_ENTER":"function"==typeof t._enter&&t._enter();break;case"KEY_BACK":"function"==typeof t._back?t._back():BackParent();break;default:"function"==typeof mediaEvent&&mediaEvent(_keyName)}};